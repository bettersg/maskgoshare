<!DOCTYPE html> 
<html lang="en" style="height:100%;">
    <head> 
        <meta charset="utf-8"> 
        <title>MaskGoShare - by better.sg</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <meta name="keywords" content="masks coronavirus wuhan singapore"/>
        <meta name="description" content="Mask Go Share - by better.sg"/>
        <link rel="shortcut icon" href="ico/favicon.png"> 
        <!-- Core CSS -->         
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet"> 
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,300,600,700" rel="stylesheet">
        <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet">
        <!-- Style Library -->         
        <link href="css/style-library-1.css" rel="stylesheet">
        <link href="css/plugins.css" rel="stylesheet">
        <link href="css/blocks.css" rel="stylesheet">
        <link href="css/custom.css" rel="stylesheet">
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->         
        <!--[if lt IE 9]>
<script src="js/html5shiv.js"></script>
<script src="js/respond.min.js"></script>
<![endif]-->         
        <meta name="author" content="better.sg">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function(){
            $.getJSON('https://v2-api.sheety.co/3035041ee3fdb393cc81ecd0720b6a63/maskGoShare/sheet1', function(data) {
            var template = Handlebars.compile($('#item-template').html())
            $('#requestlist').html(template(data.sheet1))
            })
            })
 
</script>
        <script id="item-template" type="text/x-handlebars-template">
           
                {{#each this}}
                <tr> 
                    <th>{{date}}</th> 
                    <td>{{item}}</td> 
                    <td>{{comments}}</td> 
                    <td>S({{postalcode}})</td> 
                </tr>                   
              
                {{/each}}
           
            </script>         
        <script type="text/javascript">
            $(document).ready(async function(){
                let getCoords = async (postalCode) => {
                    const onemapRes = 
                        await fetch(
                            "https://developers.onemap.sg/commonapi/search?searchVal=" + 
                            postalCode + 
                            "&getAddrDetails=N&returnGeom=Y&pageNum=1");
                    const onemapJson = await onemapRes.json();
                    const lat = parseFloat(onemapJson['results'][0]['LATITUDE']);
                    const lng = parseFloat(onemapJson['results'][0]['LONGITUDE']);
                    return [lat, lng];
                };
                $('#submitrequest').submit(async function(e) {
                    e.preventDefault();
                    let form = $(this);
                    $.ajax({
                        type: 'post',
                        dataType: 'json',
                        url: form.attr('action'),
                        data: {
                        sheet1: {
                            item: $('#item').val(),
                            comments: $('#comments').val(),
                            email: $('#email').val(),
                            postalcode: $('#postalcode').val(),
                            mailbox: $('#mailbox').val(),
                        } 
                        },
                        success: function() {
                        $('#submitrequest-success').show();
                        $('#submitrequest').hide();
                        },
                        error: function(xhr, res, text) {
                        alert(text);
                        }
                    });
                });
                const allDataRes = await fetch(
                    "https://v2-api.sheety.co/3035041ee3fdb393cc81ecd0720b6a63/maskGoShare/sheet1"
                );
                const allDataJson = await allDataRes.json();
                const allData = allDataJson['sheet1'];
                let coords = [];
                for (let request of allData) {
                    const postalCode = request.postalcode;
                    try {
                        [lat, lng] = await getCoords(postalCode);
                        coords.push({...request, lat, lng});
                    } catch(e) {
                        console.log("invalid postal code: " + postalCode);
                    }
                }
                $('#searchpostalcodeform').submit(async function(e) {
                    e.preventDefault();
                    const postalCode = $('#searchpostalcode').val();
                    $('#requestlist').hide();
                    $('#searchpostalcodeform').hide();
                    $('#requestsearch').show();  
                    try {
                        [lat, lng] = await getCoords(postalCode);
                        coords.map(obj => {
                            obj.distance = Math.pow(obj.lat - lat, 2) + Math.pow(obj.lng - lng, 2);
                        })
                        coords.sort((a, b) => a.distance - b.distance);
                        const template = Handlebars.compile($('#searchresults').html());
                        $('#requestsearch').html(template(coords));
                    } catch(e) {
                        $.getJSON('https://v2-api.sheety.co/3035041ee3fdb393cc81ecd0720b6a63/maskGoShare/sheet1?postalcode='+$('#searchpostalcode').val(), function(data) {
                            var template = Handlebars.compile($('#searchresults').html())
                            $('#requestsearch').html(template(data.sheet1))
                        });
                    }
                });
            });
        </script>         
        <script id="searchresults" type="text/x-handlebars-template">
                    <ul class="requestsearch">
                        Nearest neighbour:
                        {{#each this}}
                            <li>                                          
                                <p>{{item}} at S({{postalcode}})</p>
                                                    
                            </li>
                        {{/each}}
                    </ul>
                    </script>         
    </head>     
    <body data-spy="scroll" data-target="nav">
        <section id="content-1-1" class="bg-white min-height-300px min-height-xs-300px content-1-1 content-block">
            <div class="container text-center">
                <h1>Mask GO SHARE</h1>
                <p class="lead">Offer to help your neighbours. Request for emergency supplies.</p>
            </div>
        </section>
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h3><b>I can help someone</b></h3> 
                    <p>If you have more than you need, please consider helping a neighbour. You can browse through the requests and just drop off the supplies in their mailbox, or contact them to collect it from you.</p>
                    <form id="searchpostalcodeform" action="https://v2-api.sheety.co/3035041ee3fdb393cc81ecd0720b6a63/maskGoShare/sheet1"> 
                        <div class="form-group"> 
                            <input type="text" class="form-control" id="searchpostalcode" placeholder="Enter your postal code"> 
                        </div>                         
                        <button type="submit" class="btn btn-block btn-dark" value="Search Requests">Search Requests</button>
                        <table class="table"> 
                            <thead> 
                                <tr> 
                                    <th>Date</th> 
                                    <th>Request</th> 
                                    <th>Remarks</th> 
                                    <th>Postal Code</th> 
                                </tr>                                 
                            </thead>                             
                            <tbody id="requestlist"></tbody>                             
                        </table>                         
                    </form>                     
                    Search function is still work-in-progress.                            
                    <div id="requestlist"></div>                     
                    <div id="requestsearch"></div>                     
                </div>
                <div class="col-md-6 bg-clouds">
                    <h3><b>I need some supplies</b></h3> 
                    <p>If you really have a need for emergency supplies and would not mind some help from a neighbour, please fill in your request below and someone will hopefully get in touch.</p>
                    <form id="submitrequest" action="https://v2-api.sheety.co/3035041ee3fdb393cc81ecd0720b6a63/maskGoShare/sheet1">
                        <div class="form-group"> 
                            <input type="text" class="form-control" name="item" id="item" placeholder="Item you need and quantity"> 
                        </div>
                        <div class="form-group"> 
                            <input type="text" class="form-control" name="comments" id="comments" placeholder="Reason or remarks"> 
                        </div>
                        <div class="form-group"> 
                            <input type="email" class="form-control" name="email" id="email" placeholder="Your email address"> 
                        </div>
                        <div class="form-group"> 
                            <input type="text" class="form-control" name="postalcode" id="postalcode" placeholder="Your Postal Code"> 
                        </div>
                        <div class="form-group"> 
                            <input type="text" class="form-control" name="mailbox" id="mailbox" placeholder="Your unit number">
                            <label class="control-label small">Your unit number will be shown to people who are willing to help.</label>                             
                        </div>                         
                        <button type="submit" class="btn btn-block btn-info">Submit Request
</button>                         
                    </form>                     
                    <div id="submitrequest-success" style="display: none;">
                        Thanks - we've added your request to the list
</div>                     
                </div>
            </div>
        </div>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>         
        <script type="text/javascript" src="js/plugins.js"></script>
        <script src="https://maps.google.com/maps/api/js?sensor=true"></script>
        <script type="text/javascript" src="js/bskit-scripts.js"></script>         
    </body>     
</html>
